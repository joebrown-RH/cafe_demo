---
- name: Windows Offline Setup with Staged Chocolatey Packages
  hosts: all
  gather_facts: yes
  
  # --- Variables for Staged Paths ---
  # Define the paths used by the Execution Environment (EE)
  vars:
    # Internal EE path where chocolatey.nupkg and other packages are staged
    ee_stage_dir: "/opt/ansible/stage/chocolatey"
    # Temporary directory on the Windows target node
    win_temp_dir: "C:\\Temp"
    # Local directory on the Windows node where Chocolatey installs local packages
    choco_local_repo: "C:\\ProgramData\\chocolatey\\lib-local"
    # Default Chocolatey installation directory
    choco_install_dir: "C:\\ProgramData\\chocolatey"

  tasks:
    
    - name: Ensure target temp directory exists ({{ win_temp_dir }})
      ansible.windows.win_file:
        path: "{{ win_temp_dir }}"
        state: directory

    - name: Ensure Chocolatey local repository exists ({{ choco_local_repo }})
      ansible.windows.win_file:
        path: "{{ choco_local_repo }}"
        state: directory


    - name: Copy the Chocolatey core installation package (chocolatey.nupkg)
      ansible.windows.win_copy:
        # Source: Location inside the Execution Environment
        src: "{{ ee_stage_dir }}\\chocolatey.nupkg"
        # Destination: Temporary location on the Windows node
        dest: "{{ win_temp_dir }}\\chocolatey.nupkg"

    - name: Install Chocolatey using the local package via PowerShell
      # This task moves the nupkg to the final choco path and triggers local installation
      ansible.windows.win_powershell:
        script: |
          $ChocoPath = "{{ choco_install_dir }}"
          $TempChocoNupkg = "{{ win_temp_dir }}\\chocolatey.nupkg"
          
          # 1. Ensure the final Chocolatey directory exists
          If (-not (Test-Path $ChocoPath)) {
              New-Item -Path $ChocoPath -ItemType Directory -Force
          }
          
          # 2. Rename and move the nupkg to the required location for local install
          Rename-Item -Path $TempChocoNupkg -NewName tools.nupkg -Force
          Move-Item -Path "{{ win_temp_dir }}\\tools.nupkg" -Destination $ChocoPath\tools.nupkg -Force
          
          # 3. Trigger the internal installation logic (creates choco.exe, sets path)
          # Note: The 'choco.exe install' will run locally against the tools.nupkg just moved.
          & "$ChocoPath\bin\choco.exe" install chocolatey -y --source $ChocoPath


    - name: Copy the example package (git.nupkg) to the local repository
      ansible.windows.win_copy:
        # Source: Location inside the Execution Environment
        src: "{{ ee_stage_dir }}\\git.nupkg"
        # Destination: Local repository folder on the Windows node
        dest: "{{ choco_local_repo }}\\git.nupkg"

    - name: Install example package (git) from the local repository
      # Use the win_chocolatey module, but specify the local source path
      chocolatey.chocolatey.win_chocolatey:
        name: git
        state: present
        # This parameter forces Chocolatey to look in this local folder only
        source: "{{ choco_local_repo }}"

    - name: Clean up temporary Chocolatey package files
      ansible.windows.win_file:
        path: "{{ win_temp_dir }}\\tools.nupkg"
        state: absent
      ignore_errors: yes # Ignore if the file was cleaned up by choco installer
